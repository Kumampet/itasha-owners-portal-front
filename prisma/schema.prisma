// Prisma 7では、datasource.urlはprisma.config.tsで設定します
datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

// ユーザー情報
model User {
  // MySQLではUUIDに対応するデータ型を明示的に指定
  id               String       @id @default(uuid()) @db.VarChar(36) @map("id") // UUIDは通常VARCHAR(36)を使用
  email            String       @unique
  emailVerified    DateTime?
  name             String?
  display_name     String?      // 表示名（ニックネーム、任意）
  image            String?
  is_banned        Boolean      @default(false)
  role             String       @default("USER") // USER, ADMIN, ORGANIZER
  
  // 公開プロフィール設定
  is_profile_public Boolean     @default(false)
  custom_profile_url String?    @unique // 例: /user/itasha_taro
  
  // 管理画面用パスワード（ハッシュ化済み、通常ユーザーはnull）
  password          String?     @db.VarChar(255)
  
  // 初回ログイン時にパスワード変更を強制するフラグ
  must_change_password Boolean   @default(false)
  
  // MySQLではDateTimeの代わりにDateTimeTzを使用しないため、@db.DateTime(6) などで精度を指定できますが、
  // デフォルトのままにしておきます。
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  // NextAuth.js用のリレーション
  accounts         Account[]
  sessions         Session[]

  // リレーション
  events_participating UserEvent[] // 参加/フォローしているイベント
  groups_leading       Group[]     @relation("GroupLeader") // リーダーを務める団体
  group_messages       GroupMessage[] // 団体メッセージの履歴
  event_follows        EventFollow[] // フォローしているイベント
  
  // 【修正】主催しているイベントのリスト
  events_organized     Event[]      @relation("EventOrganizer")
  
  // 情報提供フォーム
  event_submissions    EventSubmission[]
  
  // リマインダー
  reminders            Reminder[]
  
  // 通知設定
  notification_settings UserNotificationSettings?

  @@map("users")
}

// NextAuth.js用のAccountモデル
model Account {
  id                String  @id @default(uuid()) @db.VarChar(36)
  userId            String  @db.VarChar(36)
  type              String
  provider          String
  providerAccountId String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth.js用のSessionモデル
model Session {
  id           String   @id @default(uuid()) @db.VarChar(36)
  sessionToken String   @unique
  userId       String   @db.VarChar(36)
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth.js用のVerificationTokenモデル
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// イベント情報 (マスターデータ)
model Event {
  id               String       @id @default(uuid()) @db.VarChar(36)
  name             String
  theme            String?
  // MySQLのTEXT型は @db.Text で指定
  description      String?      @db.Text
  
  // イベント情報の追跡・更新検知のためのURL (Xの投稿URLも含む)
  original_url     String       @unique
  
  event_date       DateTime
  entry_start_at   DateTime?
  payment_due_at   DateTime?

  // 開催地（住所）情報
  postal_code      String?      // 郵便番号（任意）
  prefecture       String?      // 都道府県（必須）
  city             String?      // 市区町村（必須）
  street_address   String?      // 番地（必須）
  venue_name       String?      // 固有会場名（任意）

  // 承認ステータス (DRAFT, PENDING, APPROVED, REJECTED)
  // DRAFT: 下書き（未公開）、PENDING: 承認待ち、APPROVED: 承認済み、REJECTED: 却下
  approval_status  String       @default("DRAFT")
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  // リレーション
  organizer_user   User?        @relation("EventOrganizer", fields: [organizer_user_id], references: [id])
  organizer_user_id String?     @db.VarChar(36)
  
  // 主催者メールアドレス（手動入力可能、申請時に自動設定される）
  organizer_email  String?      @db.VarChar(255)
  
  participants     UserEvent[]
  groups           Group[]
  tags             EventTag[]
  followers        EventFollow[]
  reminders        Reminder[]
  
  @@map("events")
}

// ユーザーとイベントの参加・フォロー状況 (User_Events Tableを代替)
model UserEvent {
  user             User         @relation(fields: [user_id], references: [id])
  user_id          String       @db.VarChar(36)
  event            Event        @relation(fields: [event_id], references: [id])
  event_id         String       @db.VarChar(36)
  
  // ユーザーがどの併せ（団体）に参加しているかを示すID (Optional)
  group            Group?       @relation(fields: [group_id], references: [id])
  group_id         String?      @db.VarChar(36)
  
  // 参加ステータス (INTERESTED, REGISTERED, PAID, ATTENDED)
  status           String       @default("INTERESTED")
  
  // プッシュ通知のサブスクリプション情報 (FCMトークンなど)
  // MySQLではネイティブなJSON型を使用
  push_subscription Json?        

  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@id([user_id, event_id])
  @@map("user_events")
}

// 団体情報 (併せ)
model Group {
  id               String       @id @default(uuid()) @db.VarChar(36)
  event            Event        @relation(fields: [event_id], references: [id])
  event_id         String       @db.VarChar(36)
  
  name             String
  theme            String?
  max_members      Int?
  
  // 団体コード（8桁の数字、ユニーク）
  group_code       String       @unique @db.VarChar(8)
  
  // リーダーは必ずUserテーブルを参照
  leader           User         @relation("GroupLeader", fields: [leader_user_id], references: [id])
  leader_user_id   String       @db.VarChar(36)
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  // リレーション
  members          UserEvent[]   // 団体に参加しているメンバー
  messages         GroupMessage[]
  
  @@unique([event_id, name]) // 同一イベント内で団体名はユニーク
  @@map("groups")
}

// 団体メッセージ (一斉連絡/掲示板)
model GroupMessage {
  id               String       @id @default(uuid()) @db.VarChar(36)
  group            Group        @relation(fields: [group_id], references: [id])
  group_id         String       @db.VarChar(36)
  sender           User         @relation(fields: [sender_id], references: [id])
  sender_id        String       @db.VarChar(36)
  
  content          String       @db.Text // MySQLのTEXT型
  
  // trueの場合、SESによるメール通知も行う (一斉連絡フラグ)
  is_announcement  Boolean      @default(false)
  
  created_at       DateTime     @default(now())
  
  @@map("group_messages")
}

// タグマスター
model Tag {
  id               String       @id @default(uuid()) @db.VarChar(36)
  name             String       @unique
  usage_count      Int          @default(1)
  
  // リレーション
  events           EventTag[]
  
  @@map("tags")
}

// イベント-タグ紐付け
model EventTag {
  event            Event        @relation(fields: [event_id], references: [id])
  event_id         String       @db.VarChar(36)
  tag              Tag          @relation(fields: [tag_id], references: [id])
  tag_id           String       @db.VarChar(36)
  
  created_at       DateTime     @default(now())
  
  @@id([event_id, tag_id])
  @@map("event_tags")
}

// イベントのフォロー (SNS要素ではない、単なるリマインダーリスト)
model EventFollow {
  user             User         @relation(fields: [user_id], references: [id])
  user_id          String       @db.VarChar(36)
  event            Event        @relation(fields: [event_id], references: [id])
  event_id         String       @db.VarChar(36)
  
  followed_at      DateTime     @default(now())

  @@id([user_id, event_id])
  @@map("event_follows")
}

// ユーザーからのイベント情報提供
model EventSubmission {
  id               String       @id @default(uuid()) @db.VarChar(36)
  
  // 提供者情報（未ログインの場合はnull）
  submitter        User?        @relation(fields: [submitter_id], references: [id])
  submitter_id     String?     @db.VarChar(36)
  submitter_email  String?     // 未ログインの場合のメールアドレス
  
  // イベント情報
  name             String
  theme            String?
  description      String?      @db.Text
  original_url     String
  event_date       DateTime?
  entry_start_at   DateTime?
  payment_due_at   DateTime?
  
  // 処理ステータス (PENDING, PROCESSED, REJECTED)
  status           String       @default("PENDING")
  
  // 処理メモ（管理者が記入）
  admin_note       String?      @db.Text
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  
  @@map("event_submissions")
}

// リマインダー
model Reminder {
  id               String       @id @default(uuid()) @db.VarChar(36)
  user             User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id          String       @db.VarChar(36)
  event            Event        @relation(fields: [event_id], references: [id], onDelete: Cascade)
  event_id         String       @db.VarChar(36)
  
  // リマインダーの種類（将来の仕様変更に対応するため、JSONで柔軟に保存）
  // 例: {"type": "entry_start", "datetime": "2025-01-01T00:00:00Z", "label": "エントリー開始"}
  reminder_data    Json         @db.Json
  
  // 備考（任意）
  note             String?      @db.Text
  
  // 通知送信済みフラグ
  notified         Boolean      @default(false)
  
  // 通知送信日時
  notified_at      DateTime?
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  
  @@index([user_id, event_id])
  @@map("reminders")
}

// ユーザー通知設定
model UserNotificationSettings {
  id               String       @id @default(uuid()) @db.VarChar(36)
  user             User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id          String       @unique @db.VarChar(36)
  
  // ブラウザ通知を有効にするか
  browser_notification_enabled Boolean @default(true)
  
  // メール通知を有効にするか
  email_notification_enabled Boolean @default(true)
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  
  @@map("user_notification_settings")
}
