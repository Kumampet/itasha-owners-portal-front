generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model User {
  id                      String                    @id @default(uuid()) @map("id") @db.VarChar(36)
  email                   String                    @unique
  is_banned               Boolean                   @default(false)
  role                    String                    @default("USER")
  is_profile_public       Boolean                   @default(false)
  custom_profile_url      String?                   @unique
  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt
  emailVerified           DateTime?
  image                   String?
  name                    String?
  password                String?                   @db.VarChar(255)
  must_change_password    Boolean                   @default(false)
  display_name            String?
  deleted_at              DateTime?
  accounts                Account[]
  contact_submissions     ContactSubmission[]
  event_follows           EventFollow[]
  event_submissions       EventSubmission[]
  events_created          Event[]                   @relation("EventCreator")
  group_message_reactions GroupMessageReaction[]    @relation("GroupMessageReactionUser")
  group_message_reads     GroupMessageRead[]        @relation("GroupMessageReadUser")
  group_messages          GroupMessage[]            @relation("GroupMessageSender")
  groups_leading          Group[]                   @relation("GroupLeader")
  organizer_applications  OrganizerApplication[]
  push_subscriptions      PushSubscription[]
  reminders               Reminder[]
  sessions                Session[]
  events_participating    UserEvent[]
  user_groups             UserGroup[]
  notification_settings   UserNotificationSettings?

  @@map("users")
}

model Account {
  id                String  @id @default(uuid()) @db.VarChar(36)
  userId            String  @db.VarChar(36)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "accounts_userId_fkey")
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.VarChar(36)
  sessionToken String   @unique
  userId       String   @db.VarChar(36)
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Event {
  id                     String        @id @default(uuid()) @db.VarChar(36)
  name                   String
  description            String        @db.VarChar(200)
  event_date             DateTime
  approval_status        String        @default("DRAFT")
  created_at             DateTime      @default(now())
  updated_at             DateTime      @updatedAt
  city                   String?
  postal_code            String?
  prefecture             String?
  street_address         String?
  venue_name             String?
  event_end_date         DateTime?
  image_url              String?       @db.VarChar(500)
  is_multi_day           Boolean       @default(false)
  keywords               Json?
  official_urls          Json
  payment_methods        Json?
  created_by_user_id     String?       @db.VarChar(36)
  entry_selection_method String        @default("FIRST_COME")
  max_participants       Int?
  entries                EventEntry[]
  followers              EventFollow[]
  tags                   EventTag[]
  created_by_user        User?         @relation("EventCreator", fields: [created_by_user_id], references: [id])
  groups                 Group[]
  reminders              Reminder[]
  participants           UserEvent[]
  user_groups            UserGroup[]

  @@index([event_date])
  @@index([approval_status])
  @@index([event_date, approval_status])
  @@index([created_by_user_id], map: "events_created_by_user_id_fkey")
  @@map("events")
}

model EventEntry {
  id                           String    @id @default(uuid()) @db.VarChar(36)
  event_id                     String    @db.VarChar(36)
  entry_number                 Int
  entry_start_at               DateTime
  entry_start_public_at        DateTime?
  entry_deadline_at            DateTime?
  payment_due_at               DateTime?
  payment_due_public_at        DateTime?
  created_at                   DateTime  @default(now())
  updated_at                   DateTime  @updatedAt
  payment_due_days_after_entry Int?
  payment_due_type             String    @default("ABSOLUTE")
  event                        Event     @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@unique([event_id, entry_number])
  @@map("event_entries")
}

model UserEvent {
  user_id           String   @db.VarChar(36)
  event_id          String   @db.VarChar(36)
  group_id          String?  @db.VarChar(36)
  status            String   @default("INTERESTED")
  push_subscription Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  event             Event    @relation(fields: [event_id], references: [id])
  group             Group?   @relation(fields: [group_id], references: [id])
  user              User     @relation(fields: [user_id], references: [id])

  @@id([user_id, event_id])
  @@index([event_id], map: "user_events_event_id_fkey")
  @@index([group_id], map: "user_events_group_id_fkey")
  @@map("user_events")
}

model Group {
  id             String         @id @default(uuid()) @db.VarChar(36)
  event_id       String         @db.VarChar(36)
  name           String
  theme          String?
  max_members    Int?
  leader_user_id String         @db.VarChar(36)
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt
  group_code     String         @unique @db.VarChar(8)
  owner_note     String?        @db.Text
  // 団体の説明（今後仕様予定）
  group_description String?     @db.Text
  messages       GroupMessage[]
  event          Event          @relation(fields: [event_id], references: [id])
  leader         User           @relation("GroupLeader", fields: [leader_user_id], references: [id])
  members        UserEvent[]
  user_groups    UserGroup[]

  @@unique([event_id, name])
  @@index([leader_user_id], map: "groups_leader_user_id_fkey")
  @@map("groups")
}

model GroupMessage {
  id              String                 @id @default(uuid()) @db.VarChar(36)
  group_id        String                 @db.VarChar(36)
  sender_id       String                 @db.VarChar(36)
  content         String                 @db.Text
  is_announcement Boolean                @default(false)
  created_at      DateTime               @default(now())
  reactions       GroupMessageReaction[]
  reads           GroupMessageRead[]
  group           Group                  @relation(fields: [group_id], references: [id])
  sender          User                   @relation("GroupMessageSender", fields: [sender_id], references: [id])

  @@index([group_id], map: "group_messages_group_id_fkey")
  @@index([sender_id], map: "group_messages_sender_id_fkey")
  @@map("group_messages")
}

model GroupMessageRead {
  id         String       @id @default(uuid()) @db.VarChar(36)
  message_id String       @db.VarChar(36)
  user_id    String       @db.VarChar(36)
  read_at    DateTime     @default(now())
  message    GroupMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
  user       User         @relation("GroupMessageReadUser", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id])
  @@index([user_id])
  @@index([message_id])
  @@map("group_message_reads")
}

model GroupMessageReaction {
  id         String       @id @default(uuid()) @db.VarChar(36)
  message_id String       @db.VarChar(36)
  user_id    String       @db.VarChar(36)
  emoji      String       @db.VarChar(10)
  created_at DateTime     @default(now())
  message    GroupMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
  user       User         @relation("GroupMessageReactionUser", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id, emoji])
  @@index([message_id])
  @@index([user_id])
  @@map("group_message_reactions")
}

model Tag {
  id          String     @id @default(uuid()) @db.VarChar(36)
  name        String     @unique
  usage_count Int        @default(1)
  events      EventTag[]

  @@map("tags")
}

model EventTag {
  event_id   String   @db.VarChar(36)
  tag_id     String   @db.VarChar(36)
  created_at DateTime @default(now())
  event      Event    @relation(fields: [event_id], references: [id])
  tag        Tag      @relation(fields: [tag_id], references: [id])

  @@id([event_id, tag_id])
  @@index([tag_id], map: "event_tags_tag_id_fkey")
  @@map("event_tags")
}

model EventFollow {
  user_id     String   @db.VarChar(36)
  event_id    String   @db.VarChar(36)
  followed_at DateTime @default(now())
  event       Event    @relation(fields: [event_id], references: [id])
  user        User     @relation(fields: [user_id], references: [id])

  @@id([user_id, event_id])
  @@index([event_id], map: "event_follows_event_id_fkey")
  @@map("event_follows")
}

model EventSubmission {
  id              String    @id @default(uuid()) @db.VarChar(36)
  submitter_id    String?   @db.VarChar(36)
  submitter_email String?
  name            String
  theme           String?
  description     String?   @db.Text
  original_url    String?
  event_date      DateTime?
  entry_start_at  DateTime?
  payment_due_at  DateTime?
  status          String    @default("PENDING")
  admin_note      String?   @db.Text
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  submitter       User?     @relation(fields: [submitter_id], references: [id])

  @@index([submitter_id], map: "event_submissions_submitter_id_fkey")
  @@map("event_submissions")
}

model Reminder {
  id            String    @id @default(uuid()) @db.VarChar(36)
  user_id       String    @db.VarChar(36)
  event_id      String?   @db.VarChar(36)
  reminder_data Json
  notified      Boolean   @default(false)
  notified_at   DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  note          String?   @db.Text
  event         Event?    @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, event_id])
  @@index([event_id], map: "reminders_event_id_fkey")
  @@map("reminders")
}

model UserNotificationSettings {
  id                                        String   @id @default(uuid()) @db.VarChar(36)
  user_id                                   String   @unique @db.VarChar(36)
  browser_notification_enabled              Boolean  @default(false)
  email_notification_enabled                Boolean  @default(true)
  created_at                                DateTime @default(now())
  updated_at                                DateTime @updatedAt
  group_message_unread_notification_enabled Boolean  @default(true)
  user                                      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}

model PushSubscription {
  id         String   @id @default(uuid()) @db.VarChar(36)
  user_id    String   @db.VarChar(36)
  endpoint   String   @db.VarChar(500)
  p256dh     String   @db.Text
  auth       String   @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, endpoint])
  @@index([user_id])
  @@map("push_subscriptions")
}

model ContactSubmission {
  id           String   @id @default(uuid()) @db.VarChar(36)
  submitter_id String?  @db.VarChar(36)
  title        String   @db.VarChar(255)
  name         String   @db.VarChar(100)
  email        String   @db.VarChar(255)
  content      String   @db.Text
  status       String   @default("PENDING")
  admin_note   String?  @db.Text
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  submitter    User?    @relation(fields: [submitter_id], references: [id])

  @@index([submitter_id], map: "contact_submissions_submitter_id_fkey")
  @@map("contact_submissions")
}

model OrganizerApplication {
  id           String   @id @default(uuid()) @db.VarChar(36)
  applicant_id String?  @db.VarChar(36)
  display_name String   @db.VarChar(100)
  email        String   @db.VarChar(255)
  experience   String   @db.Text
  status       String   @default("PENDING")
  admin_note   String?  @db.Text
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  applicant    User?    @relation(fields: [applicant_id], references: [id])

  @@index([applicant_id], map: "organizer_applications_applicant_id_fkey")
  @@map("organizer_applications")
}

model UserGroup {
  user_id    String   @db.VarChar(36)
  group_id   String   @db.VarChar(36)
  event_id   String   @db.VarChar(36)
  status     String   @default("INTERESTED")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  event      Event    @relation(fields: [event_id], references: [id], onDelete: Cascade)
  group      Group    @relation(fields: [group_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, group_id])
  @@index([user_id, event_id])
  @@index([group_id])
  @@index([event_id], map: "user_groups_event_id_fkey")
  @@map("user_groups")
}
