version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - 'echo "Generating Prisma Client..."'
            - 'npx prisma generate || echo "Warning: Prisma generate failed, but continuing build"'
        build:
          commands:
            - 'echo "DATABASE_URL=$DATABASE_URL" >> .env'
            - 'echo "DATABASE_POOL_SIZE=$DATABASE_POOL_SIZE" >> .env'
            - 'echo "DATABASE_DEBUG=$DATABASE_DEBUG" >> .env'
            - 'echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env'
            - 'echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env'
            - 'echo "AUTH_URL=$AUTH_URL" >> .env'
            - 'echo "AUTH_TRUST_HOST=$AUTH_TRUST_HOST" >> .env'
            - 'echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env'
            - 'echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env'
            - 'echo "TWITTER_CLIENT_ID=$TWITTER_CLIENT_ID" >> .env'
            - 'echo "TWITTER_CLIENT_SECRET=$TWITTER_CLIENT_SECRET" >> .env'
            - 'echo "NEXT_PUBLIC_VAPID_PUBLIC_KEY=$NEXT_PUBLIC_VAPID_PUBLIC_KEY" >> .env'
            - 'echo "VAPID_PRIVATE_KEY=$VAPID_PRIVATE_KEY" >> .env'
            - 'echo "VAPID_SUBJECT=$VAPID_SUBJECT" >> .env'
            - 'echo "Running database migrations..."'
            - 'echo "Checking migration status..."'
            - 'npx prisma migrate status || true'
            - 'echo "Resolving failed migration if exists..."'
            - 'npx prisma migrate resolve --applied 20260120000002_make_email_nullable_and_remove_placeholder_local || echo "Migration resolve skipped (migration may not be in failed state or already resolved)"'
            - 'npx prisma migrate resolve --applied 20260120132004_add_group_description || echo "Migration resolve skipped (migration may not be in failed state or already resolved)"'
            - 'npx prisma migrate deploy && echo "Database migrations completed successfully" || (echo "ERROR: Database migration failed!" && exit 1)'
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*

